version: "3.9"

services:
  auth-service:
    build:
      context: ./auth-service
    environment:
      - AUTH_PORT=${AUTH_PORT:-8081}
      - JWT_SECRET=${JWT_SECRET}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - appnet

  product-service:
    build:
      context: ./product-service
    environment:
      - PRODUCT_PORT=${PRODUCT_PORT:-8082}
      - JWT_SECRET=${JWT_SECRET}
      - PRODUCT_SEED_ON_STARTUP=true
    depends_on:
      auth-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - appnet

  order-service:
    build:
      context: ./order-service
    environment:
      - ORDER_PORT=${ORDER_PORT:-8083}
      - JWT_SECRET=${JWT_SECRET}
      - PRODUCT_SERVICE_URL=http://product-service:8082
    depends_on:
      product-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8083/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - appnet

  billing-service:
    build:
      context: ./billing-service
    environment:
      - BILLING_PORT=${BILLING_PORT:-8084}
      - JWT_SECRET=${JWT_SECRET}
      - ORDER_SERVICE_URL=http://order-service:8083
    depends_on:
      order-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - appnet

  gateway:
    build:
      context: ./gateway
    environment:
      - GATEWAY_PORT=${GATEWAY_PORT:-8080}
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      billing-service:
        condition: service_healthy
    ports:
      - "${GATEWAY_PORT:-8080}:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - appnet

  ui:
    build:
      context: ./ui
    environment:
      - PORT=3000
      - API_BASE=http://gateway:8080
    depends_on:
      gateway:
        condition: service_healthy
    ports:
      - "${UI_PORT:-3000}:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - appnet

networks:
  appnet:
    driver: bridge
